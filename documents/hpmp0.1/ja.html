<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>HPMP v0.1 仕様書</title>
</head>

<body style="line-height: 170%;">
    <center>
        <h1>Hakurei Peer-to-Peer Messaging Protocol v0.1(草案)</h1>
        令和3年7月19日 WinLinux1028
    </center>
    <h2>概要</h2>
    <p>
        このプロトコルはユーザーが誰かに盗聴､検閲をされることなく連絡を行うために考案されたプロトコルです｡
    </p>
    <h2>リファレンス実装について</h2>
    <p>
        この仕様書のリファレンス実装として<a href="https://github.com/WinLinux1028/freedom_chat">freedom_chat</a>を提供します｡<br>
        freedom_chatは<a href="https://www.gnu.org/licenses/gpl-3.0.ja.html">GPLv3</a>で提供されます｡<br>
        このリファレンス実装はまだalpha段階にあり､UIもCUIで使い辛いものとなっています｡<br>
        将来的にはこのリファレンス実装のクライアント側をライブラリ化し､libfdmchatとして提供する予定です｡<br>
        また､libfdmchatを用い､GUIを実装した新しいクライアントのリファレンス実装を制作する予定です｡
    </p>
    <h2>言葉の定義</h2>
    <p>
        ノードとは利用者のそれぞれの端末を示します｡<br>
        また､ノードのリストを提供するサーバーをサーバーと略します｡
    </p>
    <h2>接続の暗号化に用いるアルゴリズム</h2>
    <p>
        デジタル署名にはEd448､鍵交換にはX448､暗号化にはXChaCha20-Poly1305が推奨です｡<br>
        これは推奨であるため､必要であれば別のアルゴリズムを用いることもできます｡
    </p>
    <h2>前提となるプロトコル</h2>
    <p>
        通常はOSI参照モデルにおいて物理層〜データリンク層にはEthernetまたはIEEE 802.11､ネットワーク層にはIPv4またはIPv6､トランスポート層にはTCPを用います｡<br>
        これは推奨であるため､可能であれば他のプロトコルを用いた実装を作成することもできます｡<br>
        例えば､物理層〜ネットワーク層にIP over Avian Carriersを用いて実装すれば古代人の気分を味わえるでしょう｡
    </p>
    <h2>ノードとサーバーの鍵交換手続き</h2>
    <p>
        1.(ノード) サーバーと接続するIPアドレスの1つのポート(推奨ポート番号: 4545番)をlistenします｡<br>
        2.(ノード) サーバーのポート(サーバーポートの推奨番号は1919番)に接続します｡<br>
        3.(ノード) サーバーに自身の鍵交換用公開鍵を送信します｡<br>
        4.(サーバー) ノードから公開鍵を受信します｡<br>
        5.(サーバー) サーバーの鍵交換用公開鍵の署名をノードに送信します｡<br>
        6.(ノード) サーバーの鍵交換用公開鍵の署名を受信します｡
        7.(サーバー) ノードにサーバーの公開鍵を送信します｡<br>
        8.(ノード) サーバーの鍵交換用公開鍵を受信し､予め持っているサーバーの署名用公開鍵を使って改ざんがされていないことを確認します｡<br>
        9.(サーバー&ノード) 互いの鍵交換用秘密鍵と互いが送信しあった公開鍵の2つを使い共通鍵を生成します｡<br>
        <br>
        補足: 鍵交換アルゴリズムにX448を使っていれば448bitの共通鍵が生成されますが､XChaCha20は256bitの鍵を使うので､共通鍵の上位256bit分をこれ以降通信に使う共通鍵とします｡
    </p>
    <h2>ノードとサーバーの接続完了までの手続き</h2>
    <p>
        1.(サーバー&ノード) 前述の鍵交換を実行します｡<br>
        2.(ノード) サーバーに自身のデジタル署名用の公開鍵を送信します｡これは後でノードIDのように使います｡<br>
        3.(サーバー) ノードのデジタル署名用公開鍵を受信します｡<br>
        4.(サーバー&ノード) 後述のping手続きを実行します｡ただし､ノードは返答する前にに署名を送信してください｡また､サーバーはその署名が正しいことを確認します｡<br>
        5.(サーバー) ノードのIPアドレスの4545番ポートに接続し､接続が成立した場合はその接続を用いてping手続きを実行します｡<br>
        6.(ノード) 4545番ポートへの接続に応じ､pingに応答します｡<br>
        7.(サーバー) 5が成功した場合はスーパーノードリストにノードのIPアドレスとノードの署名用公開鍵を追加します｡また､5が成功している場合今後の通信はこの接続を使います｡
    </p>
    <h2>ping手続き</h2>
    <p>
        1.(サーバー) ノードにランダムな8bitの値を送信します｡<br>
        2.(ノード) サーバーから値を受信し､その値から1を引いて(ただし0だった場合は1を足す)送り返します｡<br>
        3.(サーバー) 送り返された値が正しいことを確認します｡<br>
    </p>

    続きは明日書く
    <center><a href="https://winlinux1028.github.io/specs/hpmp0.1/index.html">戻る</a></center>
</body>

</html>

<style>
    h1 {
        margin: 0;
        padding: 20px;
    }

    h2 {
        border-left: 16px solid rgb(0, 0, 0);
        border-bottom: 2px solid rgb(0, 0, 0);
        padding: 4px 8px;
    }

    p {
        margin-left: 25px;
    }
</style>